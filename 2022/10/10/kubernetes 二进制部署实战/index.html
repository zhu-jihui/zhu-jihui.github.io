<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  
  <title>圣女喵喵教</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="Kubernetes 集群二进制部署实战1 前言本次实战基于 CentOS 7.9 Minimal 及 Kubernetes V1.20.15 版本，以单个 Master 三 个Node 为例 1.2 约定 本文档命令行输入，均以 [&lt;username&gt;@&lt;hostname&gt; &lt;path&gt;]# 符号表示，如 [root@master1 ~]# 注释使用 # 表示">
<meta property="og:type" content="article">
<meta property="og:title" content="圣女喵喵教">
<meta property="og:url" content="http://zhu-jihui.github.io/2022/10/10/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98/index.html">
<meta property="og:site_name" content="圣女喵喵教">
<meta property="og:description" content="Kubernetes 集群二进制部署实战1 前言本次实战基于 CentOS 7.9 Minimal 及 Kubernetes V1.20.15 版本，以单个 Master 三 个Node 为例 1.2 约定 本文档命令行输入，均以 [&lt;username&gt;@&lt;hostname&gt; &lt;path&gt;]# 符号表示，如 [root@master1 ~]# 注释使用 # 表示">
<meta property="og:locale">
<meta property="article:published_time" content="2022-10-10T07:50:16.893Z">
<meta property="article:modified_time" content="2022-09-21T12:28:25.841Z">
<meta property="article:author" content="Jihui Zhu">
<meta name="twitter:card" content="summary">
  
    <link rel="alternate" href="/atom.xml" title="圣女喵喵教" type="application/atom+xml">
  
  
    <link rel="shortcut icon" href="/favicon.png">
  
  
    
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/typeface-source-code-pro@0.0.71/index.min.css">

  
  
<link rel="stylesheet" href="/css/style.css">

  
    
<link rel="stylesheet" href="/fancybox/jquery.fancybox.min.css">

  
<meta name="generator" content="Hexo 6.3.0"></head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">圣女喵喵教</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle"> </a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="Flux RSS"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Rechercher"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Rechercher"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://zhu-jihui.github.io"></form>
      </div>
    </div>
  </div>
</header>

      <div class="outer">
        <section id="main"><article id="post-kubernetes 二进制部署实战" class="h-entry article article-type-post" itemprop="blogPost" itemscope itemtype="https://schema.org/BlogPosting">
  <div class="article-meta">
    <a href="/2022/10/10/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98/" class="article-date">
  <time class="dt-published" datetime="2022-10-10T07:50:16.893Z" itemprop="datePublished">2022-10-10</time>
</a>
    
  </div>
  <div class="article-inner">
    
    
    <div class="e-content article-entry" itemprop="articleBody">
      
        <h1 id="Kubernetes-集群二进制部署实战"><a href="#Kubernetes-集群二进制部署实战" class="headerlink" title="Kubernetes 集群二进制部署实战"></a>Kubernetes 集群二进制部署实战</h1><h4 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h4><p>本次实战基于 CentOS 7.9 Minimal 及 Kubernetes V1.20.15 版本，以单个 Master 三 个Node 为例</p>
<h5 id="1-2-约定"><a href="#1-2-约定" class="headerlink" title="1.2 约定"></a>1.2 约定</h5><ul>
<li>本文档命令行输入，均以 [&lt;username&gt;@&lt;hostname&gt; &lt;path&gt;]# 符号表示，如 [root@master1 ~]#</li>
<li>注释使用 # 表示</li>
<li>执行命令输出结果，以空行分隔</li>
</ul>
<h4 id="2-前期准备"><a href="#2-前期准备" class="headerlink" title="2 前期准备"></a>2 前期准备</h4><h5 id="2-1-服务器规划"><a href="#2-1-服务器规划" class="headerlink" title="2.1  服务器规划"></a>2.1  服务器规划</h5><p>三台服务器均为 CentOS 7.9 Minimal 版本，并以作好网络配置</p>
<p>| 角色   | IP            | 组件 |<br>| —– | ———  – | —– |<br>| master | 192.168.6.181 | kube-apiserver,kube-controller-manager,kube-scheduler,kubelet,kube-proxy,docker,etcd |<br>| node1  | 192.168.6.182 | kubelet,kube-proxy,docker,etcd |<br>| node2  | 192.168.6.183 | kubelet,kube-proxy,docker,etcd |</p>
<h5 id="2-2-安装包准备"><a href="#2-2-安装包准备" class="headerlink" title="2.2 安装包准备"></a>2.2 安装包准备</h5><p>需提前准备好以下安装包和文件</p>
<ol>
<li><a target="_blank" rel="noopener" href="https://github.com/kubernetes/kubernetes/blob/master/CHANGELOG/CHANGELOG-1.20.md">kubernetes-1.20.15</a></li>
<li><a target="_blank" rel="noopener" href="https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz">docker-19.03.9</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/etcd-io/etcd/releases/tag/v3.4.9">etcd-3.4.9</a></li>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssl_linux-amd64">cfssl</a></li>
<li><a target="_blank" rel="noopener" href="https://pkg.cfssl.org/R1.2/cfssljson_linux-amd64">cfssljson</a></li>
<li><a target="_blank" rel="noopener" href="https://docs.projectcalico.org/manifests/calico.yaml">calico.yaml</a></li>
<li><a target="_blank" rel="noopener" href="https://github.com/coredns/deployment/blob/master/kubernetes/coredns.yaml.sed">coredns.yaml</a></li>
</ol>
<h5 id="2-3-初始化配置"><a href="#2-3-初始化配置" class="headerlink" title="2.3 初始化配置"></a>2.3 初始化配置</h5><p>以下配置除设置主机名需分别执行外，其余命令三台主机均要执行</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭系统防火墙</span></span><br><span class="line">[root@localhost ~]# systemctl stop firewalld  # 临时</span><br><span class="line">[root@localhost ~]# systemctl disable firewalld  # 永久</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 SeLinux</span></span><br><span class="line">[root@localhost ~]# setenforce 0  # 临时 </span><br><span class="line">[root@localhost ~]# sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # 永久</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 swap</span></span><br><span class="line">[root@localhost ~]# swapoff -a   # 临时</span><br><span class="line">[root@localhost ~]# sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab  # 永久</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置主机名</span></span><br><span class="line">[root@localhost ~]# hostnamectl set-hostname master1</span><br><span class="line">[root@localhost ~]# hostnamectl set-hostname node1  # 在 node1 上执行</span><br><span class="line">[root@localhost ~]# hostnamectl set-hostname node2  # 在 node2 上执行</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 hosts</span></span><br><span class="line">[root@master1 ~]# cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.6.181 master1</span><br><span class="line">192.168.6.182 node1</span><br><span class="line">192.168.6.183 node2</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">时间同步</span></span><br><span class="line">[root@master1 ~]# yum install -y ntpdate</span><br><span class="line">[root@master1 ~]# ntpdate ntp.aliyun.com</span><br><span class="line"> 4 Sep 21:27:49 ntpdate[22399]: adjust time server 203.107.6.88 offset 0.001010 sec</span><br><span class="line">[root@master1 ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置免密</span></span><br><span class="line">[root@master1 ~]# ssh-keygen -t rsa</span><br><span class="line">[root@master1 ~]# ssh-copy-id root@192.168.6.182</span><br><span class="line">[root@master1 ~]# ssh-copy-id root@192.168.6.183</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建相关目录</span></span><br><span class="line">[root@master1 ~]# mkdir -p /etc/kubernetes/pki /etc/etcd ~/&#123;ssl,softwares&#125; /var/log/kubernetes/ /var/lib/etcd /etc/docker</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>注：</p>
<ol>
<li>关闭防火墙和 SeLinux 时，临时和永久都要执行，否则不会立即生效</li>
<li>修改主机名后默认以 [root@master1 ~] 前缀展示命令</li>
</ol>
<h4 id="3-安装-Docker"><a href="#3-安装-Docker" class="headerlink" title="3 安装 Docker"></a>3 安装 Docker</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 docker 压缩包放到 softwares 后解压</span></span><br><span class="line">[root@master1 ~]# ll ~/softwares </span><br><span class="line">-rw-r--r--. 1 root root 60730088 Aug  3 13:58 docker-19.03.9.tgz</span><br><span class="line">[root@master1 ~]# tar -xf ~/softwares/docker-19.03.9.tgz -C ~/softwares</span><br><span class="line">[root@master1 ~]# cp ~/softwares/docker/* /usr/bin/</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置镜像加速</span></span><br><span class="line">[root@master1 ~]# cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://psb7kyvi.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置为系统服务</span></span><br><span class="line">[root@master1 ~]# </span><br><span class="line">[root@master1 ~]# cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP \$MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ~]# systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker &amp;&amp; systemctl status docker</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="4-签署证书"><a href="#4-签署证书" class="headerlink" title="4 签署证书"></a>4 签署证书</h4><h5 id="4-1-准备-cfssl"><a href="#4-1-准备-cfssl" class="headerlink" title="4.1  准备 cfssl"></a>4.1  准备 cfssl</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 cfssl cfssljson 放到 softwares</span></span><br><span class="line">[root@master1 ~]# ll ~/softwares</span><br><span class="line">-rwxr-xr-x. 1 root      root        2277873 Aug 15 15:08 cfssljson_linux-amd64</span><br><span class="line">-rwxr-xr-x. 1 root      root       10376657 Aug 15 15:08 cfssl_linux-amd64</span><br><span class="line">drwxrwxr-x. 2      1000      1000       138 May 15  2020 docker</span><br><span class="line">-rw-r--r--. 1 root      root       60730088 Aug  3 13:58 docker-19.03.9.tgz</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">赋予可执行权限并并拷贝到 /usr/local/bin 目录</span></span><br><span class="line">[root@master1 ~]# chmod +x ~/softwares/cfssl*</span><br><span class="line">[root@master1 ~]# cp ~/softwares/cfssl_linux-amd64 /usr/local/bin/cfssl</span><br><span class="line">[root@master1 ~]# cp ~/softwares/cfssljson_linux-amd64 /usr/local/bin/cfssljson</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="4-2-自签-CA-证书"><a href="#4-2-自签-CA-证书" class="headerlink" title="4.2 自签 CA 证书"></a>4.2 自签 CA 证书</h5><p>签署的证书统一放到 ~&#x2F;ssl 目录，签署完成后复制到 &#x2F;etc&#x2F;kubernetes&#x2F;pki 目录</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">证书配置文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">expiry 字段为证书有效期，可以随意修改</span></span><br><span class="line">[root@master1 ~]# cd ~/ssl</span><br><span class="line">[root@master1 ssl]# cat &gt; ca-config.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;signing&quot;: &#123;</span><br><span class="line">        &quot;default&quot;: &#123;</span><br><span class="line">            &quot;expiry&quot;: &quot;867240h&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;profiles&quot;: &#123;</span><br><span class="line">            &quot;kubernetes&quot;: &#123;</span><br><span class="line">                &quot;usages&quot;: [</span><br><span class="line">                    &quot;signing&quot;,</span><br><span class="line">                    &quot;key encipherment&quot;,</span><br><span class="line">                    &quot;server auth&quot;,</span><br><span class="line">                    &quot;client auth&quot;</span><br><span class="line">                ],</span><br><span class="line">                &quot;expiry&quot;: &quot;867240h&quot;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">ca 证书签署申请</span></span><br><span class="line">[root@master1 ssl]# cat &gt; ca-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ],</span><br><span class="line">    &quot;ca&quot;: &#123;</span><br><span class="line">        &quot;expiry&quot;: &quot;867240h&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 ca 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -initca ca-csr.json | cfssljson -bare ca</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll ca*pem</span><br><span class="line">-rw-------. 1 root root 1675 Aug 15 15:12 ca-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1363 Aug 15 15:12 ca.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 ca 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp ca*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h4 id="5-部署-etcd-集群"><a href="#5-部署-etcd-集群" class="headerlink" title="5 部署 etcd 集群"></a>5 部署 etcd 集群</h4><h5 id="5-1-颁发证书"><a href="#5-1-颁发证书" class="headerlink" title="5.1 颁发证书"></a>5.1 颁发证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有 etcd 集群节点地址，可以多预留几个 IP 备用</span></span><br><span class="line">[root@master1 ssl]# cat &gt; etcd-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;etcd&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.6.181&quot;,</span><br><span class="line">        &quot;192.168.6.182&quot;,</span><br><span class="line">        &quot;192.168.6.183&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 etcd 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes etcd-csr.json | cfssljson -bare etcd</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll etcd*pem</span><br><span class="line">-rw-------. 1 root root 1679 Aug 15 15:49 etcd-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1440 Aug 15 15:49 etcd.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 etcd 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp etcd*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>
<h5 id="5-2-部署服务"><a href="#5-2-部署服务" class="headerlink" title="5.2 部署服务"></a>5.2 部署服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 etcd 放到 ~/softwares 并解压</span></span><br><span class="line">[root@master1 ssl]# ll ~/softwares</span><br><span class="line">-rwxr-xr-x. 1 root      root        2277873 Aug 15 15:08 cfssljson_linux-amd64</span><br><span class="line">-rwxr-xr-x. 1 root      root       10376657 Aug 15 15:08 cfssl_linux-amd64</span><br><span class="line">drwxrwxr-x. 2      1000      1000       138 May 15  2020 docker</span><br><span class="line">-rw-r--r--. 1 root      root       60730088 Aug  3 13:58 docker-19.03.9.tgz</span><br><span class="line">-rw-r--r--. 1 root      root       17364053 Aug  3 10:38 etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class="line">[root@master1 ssl]# tar -zxf ~/softwares/etcd-v3.4.9-linux-amd64.tar.gz -C ~/softwares</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写配置文件</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /etc/etcd/etcd.conf &lt;&lt; EOF</span><br><span class="line">ETCD_NAME=&quot;etcd-1&quot;</span><br><span class="line">ETCD_DATA_DIR=&quot;/var/lib/etcd/default.etcd&quot;</span><br><span class="line">ETCD_LISTEN_PEER_URLS=&quot;https://192.168.6.181:2380&quot;</span><br><span class="line">ETCD_LISTEN_CLIENT_URLS=&quot;https://192.168.6.181:2379&quot;</span><br><span class="line">ETCD_INITIAL_ADVERTISE_PEER_URLS=&quot;https://192.168.6.181:2380&quot;</span><br><span class="line">ETCD_ADVERTISE_CLIENT_URLS=&quot;https://192.168.6.181:2379&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER=&quot;etcd-1=https://192.168.6.181:2380,etcd-2=https://192.168.6.182:2380,etcd-3=https://192.168.6.183:2380&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_TOKEN=&quot;etcd-cluster&quot;</span><br><span class="line">ETCD_INITIAL_CLUSTER_STATE=&quot;new&quot;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制该配置文件到其他节点</span></span><br><span class="line">[root@master1 ssl]# scp /etc/etcd/etcd.conf root@192.168.6.182:/etc/etcd/</span><br><span class="line">[root@master1 ssl]# scp /etc/etcd/etcd.conf root@192.168.6.183:/etc/etcd/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/pki/*.pem root@192.168.6.182:/etc/kubernetes/pki/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/pki/*.pem root@192.168.6.183:/etc/kubernetes/pki/</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 node1 和 node2 的 etcd 配置文件</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下内容在 node1 节点操作</span></span><br><span class="line">[root@node1 ~]# sed -i /ETCD_NAME/cETCD_NAME=\&quot;etcd-2\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node1 ~]# sed -i /ETCD_LISTEN_PEER_URLS/cETCD_LISTEN_PEER_URLS=\&quot;https://192.168.6.182:2380\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node1 ~]# sed -i /ETCD_LISTEN_CLIENT_URLS/cETCD_LISTEN_CLIENT_URLS=\&quot;https://192.168.6.182:2379\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node1 ~]# sed -i /ETCD_INITIAL_ADVERTISE_PEER_URLS/cETCD_INITIAL_ADVERTISE_PEER_URLS=\&quot;https://192.168.6.182:2380\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node1 ~]# sed -i /ETCD_ADVERTISE_CLIENT_URLS/cETCD_ADVERTISE_CLIENT_URLS=\&quot;https://192.168.6.182:2379\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">以下内容在 node2 节点操作</span></span><br><span class="line">[root@node2 ~]# sed -i /ETCD_NAME/cETCD_NAME=\&quot;etcd-3\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node2 ~]# sed -i /ETCD_LISTEN_PEER_URLS/cETCD_LISTEN_PEER_URLS=\&quot;https://192.168.6.183:2380\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node2 ~]# sed -i /ETCD_LISTEN_CLIENT_URLS/cETCD_LISTEN_CLIENT_URLS=\&quot;https://192.168.6.183:2379\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node2 ~]# sed -i /ETCD_INITIAL_ADVERTISE_PEER_URLS/cETCD_INITIAL_ADVERTISE_PEER_URLS=\&quot;https://192.168.6.183:2380\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node2 ~]# sed -i /ETCD_ADVERTISE_CLIENT_URLS/cETCD_ADVERTISE_CLIENT_URLS=\&quot;https://192.168.6.183:2379\&quot; /etc/etcd/etcd.conf</span><br><span class="line">[root@node2 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">回到 master1 节点</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 etcd 和 etcdctl 到所有节点的 /usr/local/bin</span></span><br><span class="line">[root@master1 ssl]# cp ~/softwares/etcd-v3.4.9-linux-amd64/&#123;etcd,etcdctl&#125; /usr/local/bin</span><br><span class="line">[root@master1 ssl]# scp ~/softwares/etcd-v3.4.9-linux-amd64/&#123;etcd,etcdctl&#125; root@192.168.6.182:/usr/local/bin</span><br><span class="line">[root@master1 ssl]# scp ~/softwares/etcd-v3.4.9-linux-amd64/&#123;etcd,etcdctl&#125; root@192.168.6.183:/usr/local/bin</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="5-3-配置服务"><a href="#5-3-配置服务" class="headerlink" title="5.3 配置服务"></a>5.3 配置服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写自启动服务文件</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /lib/systemd/system/etcd.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=etcd server</span><br><span class="line">After=network.target</span><br><span class="line">After=network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/etc/etcd/etcd.conf</span><br><span class="line">WorkingDirectory=/var/lib/etcd</span><br><span class="line">ExecStart=/usr/local/bin/etcd \\</span><br><span class="line">  --cert-file=/etc/kubernetes/pki/etcd.pem \\</span><br><span class="line">  --key-file=/etc/kubernetes/pki/etcd-key.pem \\</span><br><span class="line">  --trusted-ca-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">  --peer-cert-file=/etc/kubernetes/pki/etcd.pem \\</span><br><span class="line">  --peer-key-file=/etc/kubernetes/pki/etcd-key.pem \\</span><br><span class="line">  --peer-trusted-ca-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">  --peer-client-cert-auth \\</span><br><span class="line">  --client-cert-auth</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制到 node1、node2 节点</span></span><br><span class="line">[root@master1 ssl]# scp /lib/systemd/system/etcd.service root@192.168.6.182:/lib/systemd/system/</span><br><span class="line">[root@master1 ssl]# scp /lib/systemd/system/etcd.service root@192.168.6.183:/lib/systemd/system/</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务，以下命令所有节点均要运行,无报错即启动成功</span></span><br><span class="line">[root@master1 ssl]# systemctl daemon-reload &amp;&amp; systemctl start etcd &amp;&amp; systemctl enable etcd &amp;&amp; systemctl status etcd</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h4 id="6-部署-kube-apiserver"><a href="#6-部署-kube-apiserver" class="headerlink" title="6 部署 kube-apiserver"></a>6 部署 kube-apiserver</h4><h5 id="6-1-上传-kubernetes"><a href="#6-1-上传-kubernetes" class="headerlink" title="6.1 上传 kubernetes"></a>6.1 上传 kubernetes</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 kubernetes 放到 ~/softwares 并解压</span></span><br><span class="line">[root@master1 ssl]# ll ~/softwares</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line">-rwxr-xr-x. 1 root      root        2277873 Aug  3 10:16 cfssljson_linux-amd64</span><br><span class="line">-rwxr-xr-x. 1 root      root       10376657 Aug  3 10:16 cfssl_linux-amd64</span><br><span class="line">drwxrwxr-x. 2      1000      1000         6 Sep  5 13:11 docker</span><br><span class="line">-rw-r--r--. 1 root      root       60730088 Sep  5 13:10 docker-19.03.9.tgz</span><br><span class="line">drwxr-xr-x. 3 630384594 600260513       123 May 22  2020 etcd-v3.4.9-linux-amd64</span><br><span class="line">-rw-r--r--. 1 root      root       17364053 Aug  3 10:38 etcd-v3.4.9-linux-amd64.tar.gz</span><br><span class="line">-rw-r--r--. 1 root      root      303305377 Aug  3 15:09 kubernetes-server-linux-amd64.tar.gz</span><br><span class="line">[root@master1 ssl]# tar -zxf ~/softwares/kubernetes-server-linux-amd64.tar.gz -C ~/softwares</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-apiserver,kube-controller-manager,kube-proxy,kube-scheduler,kubelet,kubectl 到 /usr/local/bin</span></span><br><span class="line">[root@master1 ssl]# cp ~/softwares/kubernetes/server/bin/kube&#123;-apiserver,-controller-manager,-proxy,-scheduler,ctl,let&#125; /usr/local/bin</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kubectl,kubelet 到子节点</span></span><br><span class="line">[root@master1 ssl]# scp /usr/local/bin/kube&#123;let,ctl,-proxy&#125; root@192.168.6.182:/usr/local/bin/</span><br><span class="line">[root@master1 ssl]# scp /usr/local/bin/kube&#123;let,ctl,-proxy&#125; root@192.168.6.183:/usr/local/bin/</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="6-2-颁发证书"><a href="#6-2-颁发证书" class="headerlink" title="6.2 颁发证书"></a>6.2 颁发证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有 apiserver 节点地址，可以多预留几个 IP 备用</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kubernetes.default.svc.cluster.local 这一串是 apiserver 的 service 域名</span></span><br><span class="line">[root@master1 ssl]# cat &gt; kube-apiserver-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;10.96.0.1&quot;,</span><br><span class="line">        &quot;192.168.6.181&quot;,</span><br><span class="line">        &quot;192.168.6.182&quot;,</span><br><span class="line">        &quot;192.168.6.183&quot;,</span><br><span class="line">        &quot;kubernetes&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 apiserver 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kube-apiserver*pem</span><br><span class="line">-rw-------. 1 root root 1679 Aug 15 16:01 kube-apiserver-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1635 Aug 15 16:01 kube-apiserver.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 apiserver 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp ~/ssl/kube-apiserver*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="6-3-部署服务"><a href="#6-3-部署服务" class="headerlink" title="6.3 部署服务"></a>6.3 部署服务</h5><h6 id="6-3-1-编写服务配置文件"><a href="#6-3-1-编写服务配置文件" class="headerlink" title="6.3.1 编写服务配置文件"></a>6.3.1 编写服务配置文件</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/kube-apiserver.conf &lt;&lt; EOF</span><br><span class="line">KUBE_APISERVER_OPTS=&quot;--enable-admission-plugins=NamespaceLifecycle,NodeRestriction,LimitRanger,ServiceAccount,DefaultStorageClass,ResourceQuota \\</span><br><span class="line">  --anonymous-auth=false \\</span><br><span class="line">  --bind-address=0.0.0.0 \\</span><br><span class="line">  --secure-port=6443 \\</span><br><span class="line">  --insecure-port=0 \\</span><br><span class="line">  --authorization-mode=Node,RBAC \\</span><br><span class="line">  --runtime-config=api/all=true \\</span><br><span class="line">  --enable-bootstrap-token-auth \\</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/16 \\</span><br><span class="line">  --token-auth-file=/etc/kubernetes/token.csv \\</span><br><span class="line">  --service-node-port-range=30000-32767 \\</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/kube-apiserver.pem \\</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/kube-apiserver-key.pem \\</span><br><span class="line">  --client-ca-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">  --kubelet-client-certificate=/etc/kubernetes/pki/kube-apiserver.pem \\</span><br><span class="line">  --kubelet-client-key=/etc/kubernetes/pki/kube-apiserver-key.pem \\</span><br><span class="line">  --service-account-key-file=/etc/kubernetes/pki/ca-key.pem \\</span><br><span class="line">  --service-account-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\</span><br><span class="line">  --service-account-issuer=https://kubernetes.default.svc.cluster.local \\</span><br><span class="line">  --etcd-cafile=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">  --etcd-certfile=/etc/kubernetes/pki/etcd.pem \\</span><br><span class="line">  --etcd-keyfile=/etc/kubernetes/pki/etcd-key.pem \\</span><br><span class="line">  --etcd-servers=https://192.168.6.181:2379,https://192.168.6.182:2379,https://192.168.6.183:2379 \\</span><br><span class="line">  --enable-swagger-ui=true \\</span><br><span class="line">  --allow-privileged=true \\</span><br><span class="line">  --apiserver-count=1 \\</span><br><span class="line">  --audit-log-maxage=30 \\</span><br><span class="line">  --audit-log-maxbackup=3 \\</span><br><span class="line">  --audit-log-maxsize=100 \\</span><br><span class="line">  --audit-log-path=/var/log/kube-apiserver-audit.log \\</span><br><span class="line">  --event-ttl=1h \\</span><br><span class="line">  --alsologtostderr=false \\</span><br><span class="line">  --log-dir=/var/log/kubernetes \\</span><br><span class="line">  --v=4&quot;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>
<h6 id="6-3-2-生成-token-文件"><a href="#6-3-2-生成-token-文件" class="headerlink" title="6.3.2 生成 token 文件"></a>6.3.2 生成 token 文件</h6><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/token.csv &lt;&lt; EOF</span><br><span class="line"><span class="meta prompt_">$</span><span class="language-bash">(<span class="built_in">head</span> -c 16 /dev/urandom | <span class="built_in">od</span> -An -t x | <span class="built_in">tr</span> -d <span class="string">&#x27; &#x27;</span>),kubelet-bootstrap,10001,<span class="string">&quot;system:kubelet-bootstrap&quot;</span></span></span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>
<h5 id="6-4-配置服务"><a href="#6-4-配置服务" class="headerlink" title="6.4 配置服务"></a>6.4 配置服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; /lib/systemd/system/kube-apiserver.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes API Server</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-apiserver.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-apiserver \$KUBE_APISERVER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机自启并启动服务，无报错即启动成功</span></span><br><span class="line">[root@master1 ssl]# systemctl daemon-reload &amp;&amp; systemctl start kube-apiserver &amp;&amp; systemctl enable kube-apiserver &amp;&amp; systemctl status kube-apiserver</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h4 id="7-部署-kubectl"><a href="#7-部署-kubectl" class="headerlink" title="7 部署 kubectl"></a>7 部署 kubectl</h4><h5 id="7-1-颁发证书"><a href="#7-1-颁发证书" class="headerlink" title="7.1 颁发证书"></a>7.1 颁发证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; kubectl-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;clusteradmin&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:masters&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kubectl 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kubectl-csr.json | cfssljson -bare kubectl</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kubectl*pem</span><br><span class="line">-rw-------. 1 root root 1675 Aug 15 16:14 kubectl-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1415 Aug 15 16:14 kubectl.pem</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="7-2-生成配置文件"><a href="#7-2-生成配置文件" class="headerlink" title="7.2 生成配置文件"></a>7.2 生成配置文件</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.6.181:6443 --kubeconfig=kube.config</span><br><span class="line">[root@master1 ~]# kubectl config set-credentials clusteradmin --client-certificate=kubectl.pem --client-key=kubectl-key.pem --embed-certs=true --kubeconfig=kube.config</span><br><span class="line">[root@master1 ssl]# kubectl config set-context kubernetes --cluster=kubernetes --user=clusteradmin --kubeconfig=kube.config</span><br><span class="line">[root@master1 ssl]# kubectl config use-context kubernetes --kubeconfig=kube.config</span><br><span class="line">[root@master1 ssl]# mkdir -p ~/.kube</span><br><span class="line">[root@master1 ssl]# cp kube.config ~/.kube/config</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="7-3-获取集群信息"><a href="#7-3-获取集群信息" class="headerlink" title="7.3 获取集群信息"></a>7.3 获取集群信息</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# kubectl cluster-info</span><br><span class="line">Kubernetes control plane is running at https://192.168.6.181:6443</span><br><span class="line">CoreDNS is running at https://192.168.6.181:6443/api/v1/namespaces/kube-system/services/kube-dns:dns/proxy</span><br><span class="line"></span><br><span class="line">To further debug and diagnose cluster problems, use &#x27;kubectl cluster-info dump&#x27;.</span><br><span class="line">[root@master1 ssl]# kubectl get all -A</span><br><span class="line">NAMESPACE   NAME                 TYPE        CLUSTER-IP   EXTERNAL-IP   PORT(S)   AGE</span><br><span class="line">default     service/kubernetes   ClusterIP   10.96.0.1    &lt;none&gt;        443/TCP   17m</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于 controll-manager 和 scheduler 尚未部署，此时 ERROR 显示 connection refused</span></span><br><span class="line">[root@master1 ssl]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Unhealthy   Get &quot;http://127.0.0.1:10252/healthz&quot;: dial tcp 127.0.0.1:10252: connect: connection refused   </span><br><span class="line">scheduler            Unhealthy   Get &quot;http://127.0.0.1:10251/healthz&quot;: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h4 id="8-部署-kube-controller-manager"><a href="#8-部署-kube-controller-manager" class="headerlink" title="8 部署 kube-controller-manager"></a>8 部署 kube-controller-manager</h4><h5 id="8-1-颁发证书"><a href="#8-1-颁发证书" class="headerlink" title="8.1 颁发证书"></a>8.1 颁发证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-controller-manager 证书签署申请</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有节点地址，可以多预留几个 IP 备用</span></span><br><span class="line">[root@master1 ssl]# cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.6.181&quot;,</span><br><span class="line">        &quot;192.168.6.182&quot;,</span><br><span class="line">        &quot;192.168.6.183&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kube-controller-manager 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kube-controller-manager*pem</span><br><span class="line">-rw-------. 1 root root 1679 Aug 15 16:32 kube-controller-manager-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1513 Aug 15 16:32 kube-controller-manager.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-controler-manager 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp ~/ssl/kube-controller-manager*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="8-2-部署服务"><a href="#8-2-部署服务" class="headerlink" title="8.2 部署服务"></a>8.2 部署服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写服务配置文件</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/kube-controller-manager.conf &lt;&lt; EOF</span><br><span class="line">KUBE_CONTROLLER_MANAGER_OPTS=&quot;--secure-port=10257 \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-controller-manager.kubeconfig \\</span><br><span class="line">  --service-cluster-ip-range=10.96.0.0/16 \\</span><br><span class="line">  --cluster-name=kubernetes \\</span><br><span class="line">  --cluster-signing-cert-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">  --cluster-signing-key-file=/etc/kubernetes/pki/ca-key.pem \\</span><br><span class="line">  --cluster-signing-duration=867240h \\</span><br><span class="line">  --tls-cert-file=/etc/kubernetes/pki/kube-controller-manager.pem \\</span><br><span class="line">  --tls-private-key-file=/etc/kubernetes/pki/kube-controller-manager-key.pem \\</span><br><span class="line">  --service-account-private-key-file=/etc/kubernetes/pki/ca-key.pem \\</span><br><span class="line">  --root-ca-file=/etc/kubernetes/pki/ca.pem \\</span><br><span class="line">  --leader-elect=true \\</span><br><span class="line">  --controllers=*,bootstrapsigner,tokencleaner \\</span><br><span class="line">  --use-service-account-credentials=true \\</span><br><span class="line">  --horizontal-pod-autoscaler-sync-period=10s \\</span><br><span class="line">  --alsologtostderr=true \\</span><br><span class="line">  --logtostderr=false \\</span><br><span class="line">  --log-dir=/var/log/kubernetes \\</span><br><span class="line">  --allocate-node-cidrs=true \\</span><br><span class="line">  --cluster-cidr=10.244.0.0/12 \\</span><br><span class="line">  --v=4&quot;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 kubeconfig</span></span><br><span class="line">[root@master1 ssl]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.6.181:6443 --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-credentials kube-controller-manager --client-certificate=kube-controller-manager.pem --client-key=kube-controller-manager-key.pem --embed-certs=true --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-context default --cluster=kubernetes --user=kube-controller-manager --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config use-context default --kubeconfig=kube-controller-manager.kubeconfig</span><br><span class="line">[root@master1 ssl]# cp kube-controller-manager.kubeconfig /etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>



<h5 id="8-3-配置服务"><a href="#8-3-配置服务" class="headerlink" title="8.3 配置服务"></a>8.3 配置服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写服务启动脚本</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /lib/systemd/system/kube-controller-manager.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes controller manager</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-controller-manager.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-controller-manager \$KUBE_CONTROLLER_MANAGER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机自启并启动服务，无报错即启动成功</span></span><br><span class="line">[root@master1 ssl]# systemctl daemon-reload &amp;&amp; systemctl start kube-controller-manager &amp;&amp; systemctl enable kube-controller-manager &amp;&amp; systemctl status kube-controller-manager</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看服务，由于 scheduler 尚未部署，此时 ERROR 显示 connection refused</span></span><br><span class="line">[root@master1 ssl]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">scheduler            Unhealthy   Get &quot;http://127.0.0.1:10251/healthz&quot;: dial tcp 127.0.0.1:10251: connect: connection refused</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h4 id="9-部署-kube-scheduler"><a href="#9-部署-kube-scheduler" class="headerlink" title="9 部署 kube-scheduler"></a>9 部署 kube-scheduler</h4><h5 id="9-1-颁发证书"><a href="#9-1-颁发证书" class="headerlink" title="9.1 颁发证书"></a>9.1 颁发证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-scheduler 证书签署申请</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">hosts 字段中，IP 为所有节点地址，可以多预留几个 IP 备用</span></span><br><span class="line">[root@master1 ssl]# cat &gt; kube-scheduler-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.6.181&quot;,</span><br><span class="line">        &quot;192.168.6.182&quot;,</span><br><span class="line">        &quot;192.168.6.183&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 scheduler 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kube-scheduler*pem</span><br><span class="line">-rw-------. 1 root root 1675 Aug 15 16:53 kube-scheduler-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1489 Aug 15 16:53 kube-scheduler.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 scheduler 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp kube-scheduler*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="9-2-部署服务"><a href="#9-2-部署服务" class="headerlink" title="9.2 部署服务"></a>9.2 部署服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写服务配置文件</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/kube-scheduler.conf &lt;&lt; EOF</span><br><span class="line">KUBE_SCHEDULER_OPTS=&quot;--address=127.0.0.1 \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kube-scheduler.kubeconfig \\</span><br><span class="line">  --leader-elect=true \\</span><br><span class="line">  --alsologtostderr=true \\</span><br><span class="line">  --logtostderr=false \\</span><br><span class="line">  --log-dir=/var/log/kubernetes \\</span><br><span class="line">  --v=4&quot;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 kubeconfig</span></span><br><span class="line">[root@master1 ssl]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.6.181:6443 --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-credentials kube-scheduler --client-certificate=kube-scheduler.pem --client-key=kube-scheduler-key.pem --embed-certs=true --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-context default --cluster=kubernetes --user=kube-scheduler --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config use-context default --kubeconfig=kube-scheduler.kubeconfig</span><br><span class="line">[root@master1 ssl]# cp kube-scheduler.kubeconfig /etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="9-3-配置服务"><a href="#9-3-配置服务" class="headerlink" title="9.3 配置服务"></a>9.3 配置服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; /lib/systemd/system/kube-scheduler.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes scheduler</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-scheduler.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-scheduler \$KUBE_SCHEDULER_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置开机自启并启动服务，无报错即启动成功</span></span><br><span class="line">[root@master1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable kube-scheduler &amp;&amp; systemctl start kube-scheduler &amp;&amp; systemctl status kube-scheduler</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">查看服务</span></span><br><span class="line">[root@master1 ssl]# kubectl get cs</span><br><span class="line">Warning: v1 ComponentStatus is deprecated in v1.19+</span><br><span class="line">NAME                 STATUS    MESSAGE             ERROR</span><br><span class="line">controller-manager   Healthy   ok                  </span><br><span class="line">scheduler            Healthy   ok                  </span><br><span class="line">etcd-1               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-2               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;   </span><br><span class="line">etcd-0               Healthy   &#123;&quot;health&quot;:&quot;true&quot;&#125;</span><br><span class="line">[root@master1 ~]# </span><br></pre></td></tr></table></figure>

<h4 id="10-部署-kubelet"><a href="#10-部署-kubelet" class="headerlink" title="10 部署 kubelet"></a>10 部署 kubelet</h4><h5 id="10-1-生成-kubelet-kubeconfig"><a href="#10-1-生成-kubelet-kubeconfig" class="headerlink" title="10.1 生成 kubelet.kubeconfig"></a>10.1 生成 kubelet.kubeconfig</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 kubeconfig</span></span><br><span class="line">[root@master1 ssl]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.6.181:6443 --kubeconfig=kubelet.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-credentials kubelet-bootstrap --token=$(awk -F, &#x27;&#123;print $1&#125;&#x27; /etc/kubernetes/token.csv) --kubeconfig=kubelet.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=kubelet.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config use-context default --kubeconfig=kubelet.kubeconfig</span><br><span class="line">[root@master1 ssl]# cp kubelet.kubeconfig /etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="10-2-生成-kubelet-conf-和-kubelet-yaml"><a href="#10-2-生成-kubelet-conf-和-kubelet-yaml" class="headerlink" title="10.2 生成 kubelet.conf 和 kubelet.yaml"></a>10.2 生成 kubelet.conf 和 kubelet.yaml</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/kubelet.conf &lt;&lt; EOF</span><br><span class="line">KUBELET_OPTS=&quot;--bootstrap-kubeconfig=/etc/kubernetes/kubelet-bootstrap.kubeconfig \\</span><br><span class="line">  --config=/etc/kubernetes/kubelet.yaml \\</span><br><span class="line">  --kubeconfig=/etc/kubernetes/kubelet.kubeconfig \\</span><br><span class="line">  --cert-dir=/etc/kubernetes/pki \\</span><br><span class="line">  --network-plugin=cni \\</span><br><span class="line">  --pod-infra-container-image=registry.cn-hangzhou.aliyuncs.com/google_containers/pause:3.2 \\</span><br><span class="line">  --logtostderr=false \\</span><br><span class="line">  --v=4 \\</span><br><span class="line">  --log-dir=/var/log/kubernetes \\</span><br><span class="line">  --fail-swap-on=false&quot;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"></span><br><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/kubelet.yaml &lt;&lt; EOF</span><br><span class="line">kind: KubeletConfiguration</span><br><span class="line">apiVersion: kubelet.config.k8s.io/v1beta1</span><br><span class="line">address: 0.0.0.0</span><br><span class="line">port: 10250</span><br><span class="line">readOnlyPort: 0</span><br><span class="line">authentication:</span><br><span class="line">  anonymous:</span><br><span class="line">    enabled: false</span><br><span class="line">  webhook:</span><br><span class="line">    cacheTTL: 2m0s</span><br><span class="line">    enabled: true</span><br><span class="line">  x509:</span><br><span class="line">    clientCAFile: /etc/kubernetes/pki/ca.pem</span><br><span class="line">authorization:</span><br><span class="line">  mode: Webhook</span><br><span class="line">  webhook:</span><br><span class="line">    cacheAuthorizedTTL: 5m0s</span><br><span class="line">    cacheUnauthorizedTTL: 30s</span><br><span class="line">cgroupDriver: systemd</span><br><span class="line">clusterDNS:</span><br><span class="line">- 10.96.0.10</span><br><span class="line">clusterDomain: cluster.local</span><br><span class="line">healthzBindAddress: 127.0.0.1</span><br><span class="line">healthzPort: 10248</span><br><span class="line">rotateCertificates: true</span><br><span class="line">evictionHard:</span><br><span class="line">  imagefs.available: 15%</span><br><span class="line">  memory.available: 100Mi</span><br><span class="line">  nodefs.available: 10%</span><br><span class="line">  nodefs.inodesFree: 5%</span><br><span class="line">maxOpenFiles: 1000000</span><br><span class="line">maxPods: 110</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="10-3-生成-kubelet-bootstrap-kubeconfig"><a href="#10-3-生成-kubelet-bootstrap-kubeconfig" class="headerlink" title="10.3 生成 kubelet-bootstrap.kubeconfig"></a>10.3 生成 kubelet-bootstrap.kubeconfig</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.6.181:6443 --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-credentials kubelet-bootstrap --token=$(awk -F, &#x27;&#123;print $1&#125;&#x27; /etc/kubernetes/token.csv) --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-context default --cluster=kubernetes --user=kubelet-bootstrap --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config use-context default --kubeconfig=kubelet-bootstrap.kubeconfig</span><br><span class="line">[root@master1 ssl]# cp kubelet-bootstrap.kubeconfig /etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="10-4-配置服务"><a href="#10-4-配置服务" class="headerlink" title="10.4 配置服务"></a>10.4 配置服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; /lib/systemd/system/kubelet.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes kubelet</span><br><span class="line">After=network.target network-online.target docker.service</span><br><span class="line">Wants=docker.service</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kubelet.conf</span><br><span class="line">ExecStart=/usr/local/bin/kubelet \$KUBELET_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl start kubelet &amp;&amp; systemctl status kubelet</span><br><span class="line">[root@master1 ssl]#</span><br></pre></td></tr></table></figure>

<h5 id="10-5-证书审批"><a href="#10-5-证书审批" class="headerlink" title="10.5 证书审批"></a>10.5 证书审批</h5><p>通过 kubectl get csr 可查看证书申请状态，如是待审批，会显示 Pending，如审批通过，会显示 Approved,Issued</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl] # kubectl create clusterrolebinding kubelet-bootstrap --clusterrole=system:node-bootstrapper --user=kubelet-bootstrap</span><br><span class="line">[root@master1 ssl]# kubectl get csr</span><br><span class="line">NAME        AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">csr-nhjj4   87s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">[root@master1 ssl]# kubectl certificate approve csr-nhjj4</span><br><span class="line">[root@master1 ssl]# kubectl get csr</span><br><span class="line">NAME        AGE   SIGNERNAME                                      REQUESTOR           CONDITION</span><br><span class="line">csr-nhjj4   2m10s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="10-6-查看节点"><a href="#10-6-查看节点" class="headerlink" title="10.6 查看节点"></a>10.6 查看节点</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于尚未安装网络插件，状态显示为 NotReady</span></span><br><span class="line">[root@master1 ssl]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES    AGE     VERSION</span><br><span class="line">master1   NotReady   &lt;none&gt;   8m44s   v1.20.15</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="10-7-node-节点部署"><a href="#10-7-node-节点部署" class="headerlink" title="10.7 node 节点部署"></a>10.7 node 节点部署</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 master1 上的 kubelet 相关文件复制到 node 节点</span></span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/kubelet&#123;-bootstrap.kubeconfig,.yaml,.conf&#125; root@192.168.6.182:/etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/kubelet&#123;-bootstrap.kubeconfig,.yaml,.conf&#125; root@192.168.6.183:/etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# scp /lib/systemd/system/kubelet.service root@192.168.6.182:/lib/systemd/system/</span><br><span class="line">[root@master1 ssl]# scp /lib/systemd/system/kubelet.service root@192.168.6.183:/lib/systemd/system/</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node1、node2 分别执行</span></span><br><span class="line">[root@node1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl start kubelet &amp;&amp; systemctl status kubelet</span><br><span class="line">[root@node1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">master 证书审批</span></span><br><span class="line">[root@master1 ssl]# kubectl get csr</span><br><span class="line">NAME        AGE   SIGNERNAME                                      REQUESTOR           CONDITION</span><br><span class="line">csr-nhjj4   2m    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-mgc79   2s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">csr-tpj26   7s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">[root@master1 ssl]# kubectl certificate approve csr-mgc79 csr-tpj26</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-mgc79 approved</span><br><span class="line">certificatesigningrequest.certificates.k8s.io/csr-tpj26 approved</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">由于尚未安装网络插件，状态均显示为 NotReady</span></span><br><span class="line">[root@master1 ssl]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES    AGE   VERSION</span><br><span class="line">master1   NotReady   &lt;none&gt;   3m     v1.20.15</span><br><span class="line">node1     NotReady   &lt;none&gt;   118s   v1.20.15</span><br><span class="line">node2     NotReady   &lt;none&gt;   2m     v1.20.15</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h4 id="11-部署-kube-proxy"><a href="#11-部署-kube-proxy" class="headerlink" title="11 部署 kube-proxy"></a>11 部署 kube-proxy</h4><h5 id="11-1-颁发证书"><a href="#11-1-颁发证书" class="headerlink" title="11.1 颁发证书"></a>11.1 颁发证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">kube-proxy 证书签署申请</span></span><br><span class="line">[root@master1 ssl]# cat &gt; kube-proxy-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-proxy&quot;,</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kube-proxy 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-proxy-csr.json | cfssljson -bare kube-proxy</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kube-proxy*pem</span><br><span class="line">-rw-------. 1 root root 1679 Aug 16 09:50 ssl/kube-proxy-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1407 Aug 16 09:50 ssl/kube-proxy.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-proxy 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp kube-proxy*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="11-2-部署服务"><a href="#11-2-部署服务" class="headerlink" title="11.2 部署服务"></a>11.2 部署服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 kube-proxy.conf</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/kube-proxy.conf &lt;&lt; EOF</span><br><span class="line">KUBE_PROXY_OPTS=&quot;--config=/etc/kubernetes/kube-proxy.yaml \\</span><br><span class="line">  --logtostderr=false \\</span><br><span class="line">  --v=4 \\</span><br><span class="line">  --log-dir=/var/log/kubernetes&quot;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 kube-proxy.yaml</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /etc/kubernetes/kube-proxy.yaml &lt;&lt; EOF</span><br><span class="line">kind: KubeProxyConfiguration</span><br><span class="line">apiVersion: kubeproxy.config.k8s.io/v1alpha1</span><br><span class="line">clientConnection:</span><br><span class="line">  kubeconfig: /etc/kubernetes/kube-proxy.kubeconfig</span><br><span class="line">bindAddress: 0.0.0.0</span><br><span class="line">clusterCIDR: 10.244.0.0/12</span><br><span class="line">healthzBindAddress: 0.0.0.0:10256</span><br><span class="line">metricsBindAddress: 0.0.0.0:10249</span><br><span class="line">mode: ipvs</span><br><span class="line">ipvs:</span><br><span class="line">  scheduler: &quot;rr&quot;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">生成 kubeconfig</span></span><br><span class="line">[root@master1 ssl]# kubectl config set-cluster kubernetes --certificate-authority=ca.pem --embed-certs=true --server=https://192.168.6.181:6443 --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-credentials kube-proxy --client-certificate=kube-proxy.pem --client-key=kube-proxy-key.pem --embed-certs=true --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config set-context default --cluster=kubernetes --user=kube-proxy --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">[root@master1 ssl]# kubectl config use-context default --kubeconfig=kube-proxy.kubeconfig</span><br><span class="line">[root@master1 ssl]# cp ~/ssl/kube-proxy.kubeconfig /etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="11-3-配置服务"><a href="#11-3-配置服务" class="headerlink" title="11.3 配置服务"></a>11.3 配置服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">编写服务启动脚本</span></span><br><span class="line">[root@master1 ssl]# cat &gt; /lib/systemd/system/kube-proxy.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Kubernetes Proxy</span><br><span class="line">Documentation=https://github.com/kubernetes/kubernetes</span><br><span class="line">After=network.target network-online.target</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=-/etc/kubernetes/kube-proxy.conf</span><br><span class="line">ExecStart=/usr/local/bin/kube-proxy \$KUBE_PROXY_OPTS</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">LimitNOFILE=65535</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">启动服务，无报错即启动成功，不是通过 pod 启动，所以 kubectl get pods -A 时无法查询到 kube-proxy 服务</span></span><br><span class="line">[root@master1 ssl]# systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl start kube-proxy &amp;&amp; systemctl status kube-proxy</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="11-4-node-节点部署"><a href="#11-4-node-节点部署" class="headerlink" title="11.4 node 节点部署"></a>11.4 node 节点部署</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 master1 上的 kubelet 相关文件复制到 node 节点</span></span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/pki/kube-proxy*.pem root@192.168.6.182:/etc/kubernetes/pki/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/kube-proxy.* root@192.168.6.182:/etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# scp /lib/systemd/system/kube-proxy.service root@192.168.6.182:/lib/systemd/system/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/pki/kube-proxy*.pem root@192.168.6.183:/etc/kubernetes/pki/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/kube-proxy.* root@192.168.6.183:/etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# scp /lib/systemd/system/kube-proxy.service root@192.168.6.183:/lib/systemd/system/</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">node1、node2 分别执行</span></span><br><span class="line">[root@node1 ~]# systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl start kube-proxy &amp;&amp; systemctl status kube-proxy</span><br><span class="line">[root@node1 ~]# </span><br></pre></td></tr></table></figure>

<h4 id="12-部署-calico"><a href="#12-部署-calico" class="headerlink" title="12 部署 calico"></a>12 部署 calico</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传 calico.yaml</span></span><br><span class="line">[root@master1 ~]# ll calico.yaml</span><br><span class="line">-rw-r--r--. 1 root root 21074 Aug 16 09:56 calico.yaml</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 Pod IP 地址段，找到 CALICO_IPV4POOL_CIDR 变量，取消注释并修改如下</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">           - name: CALICO_IPV4POOL_CIDR</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">             value: <span class="string">&quot;10.244.0.0/12&quot;</span></span></span><br><span class="line">[root@master1 ~]# kubectl apply -f calico.yaml</span><br><span class="line">[root@master1 ~]# </span><br></pre></td></tr></table></figure>



<h4 id="13-部署-coredns"><a href="#13-部署-coredns" class="headerlink" title="13 部署 coredns"></a>13 部署 coredns</h4><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">上传 coredns.yaml</span></span><br><span class="line">[root@master1 ~]# ll coredns.yaml</span><br><span class="line">-rw-r--r--. 1 root root 4293 Aug 16 10:17 coredns.yaml</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改 以下内容</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CLUSTER_DOMAIN 改为 cluster.local</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">REVERSE_CIDRS 改为 in-addr.arpa ip6.arpa</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">UPSTREAMNAMESERVER 改为 /etc/resolv.conf，如果报错，则改成当前网络所使用的 DNS 地址</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">CLUSTER_DNS_IP 改为 10.96.0.10（应与 /etc/kubernetes/kubelet.yaml 中配置的clusterDNS保持一致）</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">删除 STUBDOMAINS</span></span><br><span class="line"></span><br><span class="line">[root@master1 ~]# kubectl apply -f coredns.yaml</span><br><span class="line">[root@master1 ~]# </span><br></pre></td></tr></table></figure>



<h4 id="14-部署-dashboard-可选"><a href="#14-部署-dashboard-可选" class="headerlink" title="14 部署 dashboard(可选)"></a>14 部署 dashboard(可选)</h4><p>TODO</p>
<h4 id="15-部署-Harbor（可选）"><a href="#15-部署-Harbor（可选）" class="headerlink" title="15 部署 Harbor（可选）"></a>15 部署 Harbor（可选）</h4><h5 id="15-1-生成证书"><a href="#15-1-生成证书" class="headerlink" title="15.1 生成证书"></a>15.1 生成证书</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; harbor-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;CN&quot;: &quot;harbor&quot;,</span><br><span class="line">  &quot;hosts&quot;: [</span><br><span class="line">    &quot;127.0.0.1&quot;,</span><br><span class="line">    &quot;192.168.6.181&quot;,  </span><br><span class="line">    &quot;harbor.zdys.com&quot;</span><br><span class="line">  ],</span><br><span class="line">  &quot;key&quot;: &#123;</span><br><span class="line">    &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">    &quot;size&quot;: 2048</span><br><span class="line">  &#125;,</span><br><span class="line">  &quot;names&quot;: [</span><br><span class="line">    &#123;</span><br><span class="line">      &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">      &quot;ST&quot;: &quot;HangZhou&quot;,</span><br><span class="line">      &quot;L&quot;: &quot;XS&quot;,</span><br><span class="line">      &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">      &quot;OU&quot;: &quot;System&quot;</span><br><span class="line">    &#125;</span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes harbor-csr.json | cfssljson -bare harbor</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="15-2-安装-docker-compose"><a href="#15-2-安装-docker-compose" class="headerlink" title="15.2 安装 docker-compose"></a>15.2 安装 docker-compose</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载或手动上传 docker-compose 到 softwares 文件夹，注意 docker-compose 要和所在服务器 CPU 架构一致，查看 CPU 架构命令：`<span class="built_in">arch</span>`</span></span><br><span class="line">[root@master1 ssl]# ll ~/softwares/docker-compose*</span><br><span class="line">-rw-r--r--. 1 root root 25722880 Sep 14 15:29 /root/softwares/docker-compose-linux-x86_64</span><br><span class="line">[root@master1 ssl]# mv ~/softwares/docker-compose-linux-x86_64 /usr/local/bin/docker-compose</span><br><span class="line">[root@master1 ssl]# chmod +x /usr/local/bin/docker-compose</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="15-3-安装-Harbor"><a href="#15-3-安装-Harbor" class="headerlink" title="15.3 安装 Harbor"></a>15.3 安装 Harbor</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">下载或手动上传 harbor 到 softwares 文件夹</span></span><br><span class="line">[root@master1 ssl]# ll ~/softwares/harbor*</span><br><span class="line">-rw-r--r--. 1 root root 756124163 Aug 29 16:45 /root/softwares/harbor-offline-installer-v2.6.0.tgz</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">解压</span></span><br><span class="line">[root@master1 ssl]# tar -zcvf ~/softwares/harbor-offline-installer-v2.6.0.tgz -C ~/softwares/</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制配置文件</span></span><br><span class="line">[root@master1 ssl]# cp ~/software/harbor/harbor.yml.tmpl ~/software/harbor/harbor.yml</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">修改配置文件</span></span><br><span class="line">[root@master1 ssl]# vi ~/software/harbor/harbor.yml</span><br><span class="line">5: hostname: harbor.zdys.com</span><br><span class="line">17: certificate: /etc/kubernetes/pki/harbor.pem</span><br><span class="line">18: private_key: /etc/kubernetes/pki/harbor-key.pem</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">执行安装命令，等待安装完成</span></span><br><span class="line">[root@master1 ssl]# bash ~/software/harbor/install.sh</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="15-4-开机自启"><a href="#15-4-开机自启" class="headerlink" title="15.4 开机自启"></a>15.4 开机自启</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# cat &gt; /lib/systemd/system/harbor.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Harbor</span><br><span class="line">After=docker.service systemd-networkd.service systemd-resolved.service</span><br><span class="line">Requires=docker.service</span><br><span class="line">Documentation=http://github.com/vmware/harbor</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">Type=simple</span><br><span class="line">Restart=on-failure</span><br><span class="line">RestartSec=5</span><br><span class="line">ExecStart=/usr/local/bin/docker-compose -f  ~/software/harbor/docker-compose.yml up</span><br><span class="line">ExecStop=/usr/local/bin/docker-compose -f ~/software/harbor/docker-compose.yml down</span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# systemctl daemon-reload &amp;&amp; systemctl enable harbor &amp;&amp; systemctl start harbor &amp;&amp; systemctl status harbor</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>



<h4 id="16-部署-Ingress（可选）"><a href="#16-部署-Ingress（可选）" class="headerlink" title="16 部署 Ingress（可选）"></a>16 部署 Ingress（可选）</h4><p>TODO</p>
<h4 id="17-部署-NFS（可选）"><a href="#17-部署-NFS（可选）" class="headerlink" title="17 部署 NFS（可选）"></a>17 部署 NFS（可选）</h4><h5 id="17-1-服务端"><a href="#17-1-服务端" class="headerlink" title="17.1 服务端"></a>17.1 服务端</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils rpcbind</span><br><span class="line">mkdir /nfsdata</span><br><span class="line">chown nfsnobody.nfsnobody /nfsdata</span><br><span class="line">cat &gt;&gt; /etc/exports &lt;&lt; EOF</span><br><span class="line">/nfsdata   192.168.6.0/24(rw,sync,no_root_squash)</span><br><span class="line">EOF</span><br><span class="line">systemctl start rpcbind </span><br><span class="line">systemctl start nfs</span><br></pre></td></tr></table></figure>

<h5 id="17-2-客户端"><a href="#17-2-客户端" class="headerlink" title="17.2 客户端"></a>17.2 客户端</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum install -y nfs-utils</span><br><span class="line">mkdir /mnt/nfsdata</span><br><span class="line">mount -t  nfs 192.168.6.181:/nfsdata /mnt/nfsdata</span><br></pre></td></tr></table></figure>

<h4 id="18-新增节点"><a href="#18-新增节点" class="headerlink" title="18 新增节点"></a>18 新增节点</h4><h5 id="18-1-初始化配置"><a href="#18-1-初始化配置" class="headerlink" title="18.1 初始化配置"></a>18.1 初始化配置</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭系统防火墙</span></span><br><span class="line">[root@localhost ~]# systemctl stop firewalld  # 临时</span><br><span class="line">[root@localhost ~]# systemctl disable firewalld  # 永久</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 SeLinux</span></span><br><span class="line">[root@localhost ~]# setenforce 0  # 临时 </span><br><span class="line">[root@localhost ~]# sed -i &#x27;s/enforcing/disabled/&#x27; /etc/selinux/config  # 永久</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">关闭 swap</span></span><br><span class="line">[root@localhost ~]# swapoff -a   # 临时</span><br><span class="line">[root@localhost ~]# sed -ri &#x27;s/.*swap.*/#&amp;/&#x27; /etc/fstab  # 永久</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置主机名</span></span><br><span class="line">[root@localhost ~]# hostnamectl set-hostname node3  # 在 node2 上执行</span><br><span class="line">[root@localhost ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">添加 hosts</span></span><br><span class="line">[root@localhost ~]# cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.6.181 master1</span><br><span class="line">192.168.6.182 node1</span><br><span class="line">192.168.6.183 node2</span><br><span class="line">192.168.6.184 node3</span><br><span class="line">EOF</span><br><span class="line">[root@node3 ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">原节点新增 hosts</span></span><br><span class="line">[root@master1 ~]# cat &gt;&gt; /etc/hosts &lt;&lt; EOF</span><br><span class="line">192.168.6.184 node3</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">时间同步</span></span><br><span class="line">[root@node3 ~]# yum install -y ntpdate</span><br><span class="line">[root@node3 ~]# ntpdate ntp.aliyun.com</span><br><span class="line"> 4 Sep 21:27:49 ntpdate[22399]: adjust time server 203.107.6.88 offset 0.001010 sec</span><br><span class="line">[root@master1 ~]#</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置免密，master 上操作</span></span><br><span class="line">[root@master1 ~]# ssh-copy-id root@192.168.6.184</span><br><span class="line">[root@master1 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">创建相关目录</span></span><br><span class="line">[root@node3 ~]# mkdir -p /etc/kubernetes/pki /etc/etcd ~/&#123;ssl,softwares&#125; /var/log/kubernetes/ /etc/docker</span><br><span class="line">[root@node3 ~]# </span><br></pre></td></tr></table></figure>
<h5 id="18-2-Docker-安装"><a href="#18-2-Docker-安装" class="headerlink" title="18.2 Docker 安装"></a>18.2 Docker 安装</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">将 docker 压缩包放到 softwares 后解压</span></span><br><span class="line">[root@node3 ~]# ll softwares </span><br><span class="line">-rw-r--r--. 1 root root 60730088 Aug  3 13:58 docker-19.03.9.tgz</span><br><span class="line">[root@node3 ~]# tar -xf ~/softwares/docker-19.03.9.tgz -C ~/softwares</span><br><span class="line">[root@node3 ~]# cp ~/softwares/docker/* /usr/bin/</span><br><span class="line">[root@node3 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">配置镜像加速</span></span><br><span class="line">[root@node3 ~]# cat &gt; /etc/docker/daemon.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">  &quot;exec-opts&quot;: [&quot;native.cgroupdriver=systemd&quot;],</span><br><span class="line">  &quot;registry-mirrors&quot;: [&quot;https://psb7kyvi.mirror.aliyuncs.com&quot;]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@node3 ~]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">设置为系统服务</span></span><br><span class="line">[root@node3 ~]# </span><br><span class="line">[root@node3 ~]# cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF</span><br><span class="line">[Unit]</span><br><span class="line">Description=Docker Application Container Engine</span><br><span class="line">Documentation=https://docs.docker.com</span><br><span class="line">After=network-online.target firewalld.service</span><br><span class="line">Wants=network-online.target</span><br><span class="line">[Service]</span><br><span class="line">Type=notify</span><br><span class="line">ExecStart=/usr/bin/dockerd</span><br><span class="line">ExecReload=/bin/kill -s HUP \$MAINPID</span><br><span class="line">LimitNOFILE=infinity</span><br><span class="line">LimitNPROC=infinity</span><br><span class="line">LimitCORE=infinity</span><br><span class="line">TimeoutStartSec=0</span><br><span class="line">Delegate=yes</span><br><span class="line">KillMode=process</span><br><span class="line">Restart=on-failure</span><br><span class="line">StartLimitBurst=3</span><br><span class="line">StartLimitInterval=60s</span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br><span class="line">EOF</span><br><span class="line">[root@node3 ~]# systemctl daemon-reload &amp;&amp; systemctl start docker &amp;&amp; systemctl enable docker &amp;&amp; systemctl status docker</span><br><span class="line">[root@node3 ~]# </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="18-3-配置文件复制"><a href="#18-3-配置文件复制" class="headerlink" title="18.3 配置文件复制"></a>18.3 配置文件复制</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# scp /usr/local/bin/kube&#123;let,ctl,-proxy&#125; root@192.168.6.184:/usr/local/bin/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/kubelet&#123;-bootstrap.kubeconfig,.yaml,.conf&#125; root@192.168.6.184:/etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# scp /lib/systemd/system/kube&#123;let,-proxy&#125;.service root@192.168.6.184:/lib/systemd/system/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/pki/&#123;ca*,kube-proxy*&#125;.pem root@192.168.6.184:/etc/kubernetes/pki/</span><br><span class="line">[root@master1 ssl]# scp /etc/kubernetes/kube-proxy.* root@192.168.6.184:/etc/kubernetes/</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>
<h5 id="18-4-启动服务"><a href="#18-4-启动服务" class="headerlink" title="18.4 启动服务"></a>18.4 启动服务</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node3 ssl]# systemctl daemon-reload &amp;&amp; systemctl enable kubelet &amp;&amp; systemctl start kubelet &amp;&amp; systemctl status kubelet</span><br><span class="line">[root@node3 ssl]# systemctl daemon-reload &amp;&amp; systemctl enable kube-proxy &amp;&amp; systemctl start kube-proxy &amp;&amp; systemctl status kube-proxy</span><br><span class="line">[root@node3 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="18-5-证书审批"><a href="#18-5-证书审批" class="headerlink" title="18.5 证书审批"></a>18.5 证书审批</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# kubectl get csr</span><br><span class="line">NAME        AGE   SIGNERNAME                                    REQUESTOR           CONDITION</span><br><span class="line">csr-nhjj4   2m    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-mgc79   2s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-tpj26   7s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-rw7wt   19s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Pending</span><br><span class="line">[root@master1 ssl]# kubectl certificate approve csr-rw7wt</span><br><span class="line">[root@master1 ssl]# kubectl get csr</span><br><span class="line">NAME        AGE   SIGNERNAME                                      REQUESTOR           CONDITION</span><br><span class="line">csr-nhjj4   2m    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-mgc79   2s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-tpj26   7s    kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">csr-rw7wt   19s   kubernetes.io/kube-apiserver-client-kubelet   kubelet-bootstrap   Approved,Issued</span><br><span class="line">[root@master1 ssl]# kubectl get nodes</span><br><span class="line">NAME      STATUS     ROLES    AGE   VERSION</span><br><span class="line">master1   Ready      &lt;none&gt;   94m   v1.20.15</span><br><span class="line">node1     Ready      &lt;none&gt;   35m   v1.20.15</span><br><span class="line">node2     Ready      &lt;none&gt;   35m   v1.20.15</span><br><span class="line">node3     Ready      &lt;none&gt;   2s    v1.20.15</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>

<h5 id="18-6-Master-节点修改"><a href="#18-6-Master-节点修改" class="headerlink" title="18.6 Master 节点修改"></a>18.6 Master 节点修改</h5><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">重新生成 kube-apiserver 证书并重启服务</span></span><br><span class="line">[root@master1 ssl]# cat &gt; kube-apiserver-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;kubernetes&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;10.96.0.1&quot;,</span><br><span class="line">        &quot;192.168.6.181&quot;,</span><br><span class="line">        &quot;192.168.6.182&quot;,</span><br><span class="line">        &quot;192.168.6.183&quot;,</span><br><span class="line">        &quot;192.168.6.184&quot;,</span><br><span class="line">        &quot;kubernetes&quot;,</span><br><span class="line">        &quot;kubernetes.default&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster&quot;,</span><br><span class="line">        &quot;kubernetes.default.svc.cluster.local&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;k8s&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 apiserver 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-apiserver-csr.json | cfssljson -bare kube-apiserver</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kube-apiserver*pem</span><br><span class="line">-rw-------. 1 root root 1679 Aug 15 16:01 kube-apiserver-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1635 Aug 15 16:01 kube-apiserver.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 apiserver 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp kube-apiserver*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# systemctl restart kube-apiserver</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ssl]# cat &gt; kube-controller-manager-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.6.181&quot;,</span><br><span class="line">        &quot;192.168.6.182&quot;,</span><br><span class="line">        &quot;192.168.6.183&quot;,</span><br><span class="line">        &quot;192.168.6.184&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:kube-controller-manager&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 kube-controller-manager 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-controller-manager-csr.json | cfssljson -bare kube-controller-manager</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kube-controller-manager*pem</span><br><span class="line">-rw-------. 1 root root 1679 Aug 15 16:32 kube-controller-manager-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1513 Aug 15 16:32 kube-controller-manager.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 kube-controler-manager 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp kube-controller-manager*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# systemctl restart kube-controller-manager</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@master1 ssl]# cat &gt; kube-scheduler-csr.json &lt;&lt; EOF</span><br><span class="line">&#123;</span><br><span class="line">    &quot;CN&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">    &quot;hosts&quot;: [</span><br><span class="line">        &quot;127.0.0.1&quot;,</span><br><span class="line">        &quot;192.168.6.181&quot;,</span><br><span class="line">        &quot;192.168.6.182&quot;,</span><br><span class="line">        &quot;192.168.6.183&quot;,</span><br><span class="line">        &quot;192.168.6.184&quot;</span><br><span class="line">    ],</span><br><span class="line">    &quot;key&quot;: &#123;</span><br><span class="line">        &quot;algo&quot;: &quot;rsa&quot;,</span><br><span class="line">        &quot;size&quot;: 2048</span><br><span class="line">    &#125;,</span><br><span class="line">    &quot;names&quot;: [</span><br><span class="line">        &#123;</span><br><span class="line">            &quot;C&quot;: &quot;CN&quot;,</span><br><span class="line">            &quot;ST&quot;: &quot;Guangdong&quot;,</span><br><span class="line">            &quot;L&quot;: &quot;Zhuhai&quot;,</span><br><span class="line">            &quot;O&quot;: &quot;system:kube-scheduler&quot;,</span><br><span class="line">            &quot;OU&quot;: &quot;system&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">[root@master1 ssl]# </span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">签署 scheduler 证书</span></span><br><span class="line">[root@master1 ssl]# cfssl gencert -ca=ca.pem -ca-key=ca-key.pem -config=ca-config.json -profile=kubernetes kube-scheduler-csr.json | cfssljson -bare kube-scheduler</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">验证结果，会生成两个证书文件</span></span><br><span class="line">[root@master1 ssl]# ll kube-scheduler*pem</span><br><span class="line">-rw-------. 1 root root 1675 Aug 15 16:53 kube-scheduler-key.pem</span><br><span class="line">-rw-r--r--. 1 root root 1489 Aug 15 16:53 kube-scheduler.pem</span><br><span class="line"><span class="meta prompt_"></span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">复制 scheduler 证书到 /etc/kubernetes/pki</span></span><br><span class="line">[root@master1 ssl]# cp kube-scheduler*pem /etc/kubernetes/pki</span><br><span class="line">[root@master1 ssl]# systemctl restart kube-scheduler</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>



<h4 id="17-常见问题"><a href="#17-常见问题" class="headerlink" title="17 常见问题"></a>17 常见问题</h4><h5 id="17-1"><a href="#17-1" class="headerlink" title="17.1"></a>17.1</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">unable to read existing bootstrap client config: invalid configuration: [unable to read client-cert /etc/kubernetes/pki/kubelet-client-current.pem for default-auth due to open /etc/kubernetes/pki/kubelet-client-current.pem: no such file or directory, unable to read client-key /etc/kubernetes/pki/kubelet-client-current.pem for default-auth due to open /etc/kubernetes/pki/kubelet-client-current.pem: no such file or directory]</span><br></pre></td></tr></table></figure>

<p>解决方案：master 节点没通过证书申请，通过即可</p>
<h5 id="17-2"><a href="#17-2" class="headerlink" title="17.2"></a>17.2</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Failed at step CHDIR spawning /usr/local/bin/etcd</span><br></pre></td></tr></table></figure>
<p>解决方案：需要创建目录&#x2F;var&#x2F;lib&#x2F;etcd</p>
<h5 id="17-3"><a href="#17-3" class="headerlink" title="17.3"></a>17.3</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error: [--etcd-servers must be specified, service-account-issuer is a required flag, --service-account-signing-key-file and --service-account-issuer are required flags]</span><br></pre></td></tr></table></figure>
<p>解决方案：自启动文件指定的 $KUBE_APISERVER_OPTS 未生效</p>
<h5 id="17-4"><a href="#17-4" class="headerlink" title="17.4"></a>17.4</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@master1 ssl]# kubectl get csr</span><br><span class="line">No resources found</span><br><span class="line">[root@master1 ssl]# </span><br></pre></td></tr></table></figure>
<p>答：kubectl create clusterrolebinding kubelet-bootstrap –clusterrole&#x3D;system:node-bootstrapper –user&#x3D;kubelet-bootstrap</p>
<h5 id="17-5"><a href="#17-5" class="headerlink" title="17.5"></a>17.5</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kubectl get csr 不断增加</span><br></pre></td></tr></table></figure>
<p>解决方案：kubelet 在不停重启，journal -xe kubelet 查看日志</p>
<h5 id="17-6"><a href="#17-6" class="headerlink" title="17.6"></a>17.6</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">failed to run Kubelet: misconfiguration: kubelet cgroup driver: &quot;systemd&quot; is different from docker</span><br></pre></td></tr></table></figure>
<p>解决方案：k8s 官方推荐使用的 cgroup driver 是 systemd，而 docker 默认使用的是 cgroupfs，因此需要修改 docker 的默认 cgroup driver 为 systemd。<br>在 &#x2F;etc&#x2F;docker&#x2F;daemon.json 中新增 “exec-opts”: [“native.cgroupdriver&#x3D;systemd”] 后重启即可</p>
<h5 id="17-7"><a href="#17-7" class="headerlink" title="17.7"></a>17.7</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Error from server (Forbidden): Forbidden (user=kubernetes...</span><br></pre></td></tr></table></figure>
<p>解决方案：kubernetes 没有权限查看日志</p>
<h5 id="17-8"><a href="#17-8" class="headerlink" title="17.8"></a>17.8</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Hit error connecting to datastore - retry error=Get https://10.96.0.1:443/api/v1/nodes/foo: x509: certificate is valid for 127.0.0.1, 10.0.0.1, 192.168.6.181, 192.168.6.182, 192.168.6.183, not 10.96.0.1</span><br></pre></td></tr></table></figure>
<p>解决方案：检查 kube-apiserver 中配置的 ip 是否正确，本例中为 ip 配置错误</p>
<h4 id="18-常用命令"><a href="#18-常用命令" class="headerlink" title="18 常用命令"></a>18 常用命令</h4><h5 id="18-1-基本命令"><a href="#18-1-基本命令" class="headerlink" title="18.1 基本命令"></a>18.1 基本命令</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"># 查看所有 api-resources</span><br><span class="line">kubectl api-resources</span><br><span class="line"></span><br><span class="line"># 查看所有组件状态</span><br><span class="line">kubectl get cs</span><br><span class="line"></span><br><span class="line"># 查看所有 pod</span><br><span class="line">kubectl get pods -A -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"># 查看所有服务</span><br><span class="line">kubectl get svc</span><br></pre></td></tr></table></figure>

<h5 id="18-2-问题追踪"><a href="#18-2-问题追踪" class="headerlink" title="18.2 问题追踪"></a>18.2 问题追踪</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 查看 pod 日志</span><br><span class="line">kubectl logs &lt;pod_name&gt; -n &lt;namespace&gt;</span><br><span class="line"></span><br><span class="line"># 查看 pod 生命周期</span><br><span class="line">kubectl describe pod &lt;pod_name&gt; -n &lt;namespace&gt;</span><br></pre></td></tr></table></figure>

<h5 id=""><a href="#" class="headerlink" title=""></a></h5><h4 id="19-参考文档"><a href="#19-参考文档" class="headerlink" title="19 参考文档"></a>19 参考文档</h4><p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_44078641/article/details/120049473">https://blog.csdn.net/qq_44078641/article/details/120049473</a></p>
<p><a target="_blank" rel="noopener" href="https://www.haxi.cc/archives/setup-k8s-1-23-1-cluster-using-binary.html">https://www.haxi.cc/archives/setup-k8s-1-23-1-cluster-using-binary.html</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.horus-k.com/2020/03/12/k8s/k8s-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%8516-6/">https://blog.horus-k.com/2020/03/12/k8s/k8s-%E4%BA%8C%E8%BF%9B%E5%88%B6%E5%AE%89%E8%A3%8516-6/</a></p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://zhu-jihui.github.io/2022/10/10/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98/" data-id="cl92h5vjn00004wz6hnn8bywc" data-title="" class="article-share-link">Partager</a>
      
      
      
    </footer>
  </div>
  
    
<nav id="article-nav">
  
    <a href="/2022/10/10/%E5%9F%BA%E4%BA%8E%20Hexo%20%E7%9A%84%E5%8D%9A%E5%AE%A2%E7%94%9F%E6%88%90%E8%84%9A%E6%89%8B%E6%9E%B6/" id="article-nav-newer" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Récent</strong>
      <div class="article-nav-title">
        
          基于 Hexo 的博客生成脚手架
        
      </div>
    </a>
  
  
    <a href="/2022/10/10/hello-world/" id="article-nav-older" class="article-nav-link-wrap">
      <strong class="article-nav-caption">Ancien</strong>
      <div class="article-nav-title">Hello World</div>
    </a>
  
</nav>

  
</article>


</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Catégories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%A5%87%E6%8A%80%E6%B7%AB%E5%B7%A7/">奇技淫巧</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Mot-clés</h3>
    <div class="widget">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%8D%9A%E5%AE%A2/" rel="tag">博客</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Nuage de mot-clés</h3>
    <div class="widget tagcloud">
      <a href="/tags/%E5%8D%9A%E5%AE%A2/" style="font-size: 10px;">博客</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2022/10/">October 2022</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Articles récents</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2022/10/10/%E5%9F%BA%E4%BA%8E%20Hexo%20%E7%9A%84%E5%8D%9A%E5%AE%A2%E7%94%9F%E6%88%90%E8%84%9A%E6%89%8B%E6%9E%B6/">基于 Hexo 的博客生成脚手架</a>
          </li>
        
          <li>
            <a href="/2022/10/10/kubernetes%20%E4%BA%8C%E8%BF%9B%E5%88%B6%E9%83%A8%E7%BD%B2%E5%AE%9E%E6%88%98/">(no title)</a>
          </li>
        
          <li>
            <a href="/2022/10/10/hello-world/">Hello World</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      
      &copy; 2022 Jihui Zhu<br>
      Propulsé par <a href="https://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>

    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    


<script src="/js/jquery-3.4.1.min.js"></script>



  
<script src="/fancybox/jquery.fancybox.min.js"></script>




<script src="/js/script.js"></script>





  </div>
</body>
</html>